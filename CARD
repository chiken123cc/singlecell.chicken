
#############################################################spatial.transcriptomics




devtools::install_github('YingMa0107/CARD')


library(CARD)
library(MuSiC)
library(Seurat)
library(patchwork)
library(tidyverse)
library(viridis)


spatial_count <-  pbmc@assays$RNA@counts


spatial_loca <- pbmc@reductions[["umap"]]@cell.embeddings
spatial_location <- spatial_loca
colnames(spatial_location) <- c("x","y")
spatial_location <- as.data.frame(spatial_location)


pbmc_1 <- readRDS("embryo_1.0_1000.rds")


sc_count <- pbmc_1@assays$RNA@counts


sc_meta <- pbmc_1@meta.data %>% 
  rownames_to_column("cellID") %>%
  dplyr::select(cellID,orig.ident,cell_type) %>% 
  mutate(CB = cellID) %>% 
  column_to_rownames("CB")



CARD_obj = createCARDObject( 
  sc_count = sc_count, 
  sc_meta = sc_meta, 
  spatial_count = spatial_count, 
  spatial_location = spatial_location, 
  ct.varname = "cell_type", 
  ct.select = unique(sc_meta$cell_type),
  sample.varname = "orig.ident")

## create reference matrix from scRNASeq...
## Select Informative Genes! ...
## Deconvolution Starts! ...
## Deconvolution Finish! ...

CARD_obj = CARD_deconvolution(CARD_object = CARD_obj)

load('co.L4.RData')

#1. Imputation on the newly grided spatial locations #
CARD_obj = CARD.imputation(CARD_obj,NumGrids = 3000,ineibor = 10,exclude = NULL)

## Visualize the newly grided spatial locations 
# to see if the shape is correctly detected.
# If not, the user can provide the row names of the 
# excluded spatial location data into the CARD.imputation function
location_imputation = cbind.data.frame(x=as.numeric(sapply(strsplit(rownames(CARD_obj@refined_prop),split="x"),"[",1)),
                                       y=as.numeric(sapply(strsplit(rownames(CARD_obj@refined_prop),split="x"),"[",2)))
rownames(location_imputation) = rownames(CARD_obj@refined_prop)


length(rownames(CARD_obj@refined_prop))
length(rownames(location_imputation))

colors<- c("lightblue","lightyellow","red",
 "#FF34B3","#BC8F8F","#20B2AA","#00F5FF","#FFA500","#ADFF2F",
 "#FF6A6A","#7FFFD4", "#AB82FF","#90EE90","#00CD00","#008B8B",
 "#6495ED","#FFC1C1","#CD5C5C","#8B008B","#FF3030", "#7CFC00") 

CARD.visualize.pie(
  proportion = CARD_obj@Proportion_CARD,
  spatial_location = CARD_obj@spatial_location, 
  colors = colors, 
  radius = 2) ### You can choose radius = NULL or your own radius number

CARD.visualize.prop(
  proportion = CARD_obj@Proportion_CARD,        
  spatial_location = CARD_obj@spatial_location, 
  ct.visualize = c("GC_B(I)","GC_B(II)","LYZ+DC","naive b"),                 ### selected cell types to visualize
  colors = c("lightblue","lightyellow","red"), ### if not provide, we will use the default colors
  NumCols = 4,                                 ### number of columns in the figure panel
  pointSize = 3.0) 


CARD.visualize.prop.2CT(
  proportion = CARD_obj@Proportion_CARD,                             ### Cell type proportion estimated by CARD
  spatial_location = CARD_obj@spatial_location,                  ### two cell types you want to visualize
  ct2.visualize = c("GC_B(I)","GC_B(II)","LYZ+DC","naive b"),
  colors = list(c("lightblue","lightyellow","red"),c("lightblue","lightyellow","black")))       ### two color scales                             



CARD.visualize.gene(
  spatial_expression = CARD_obj@spatial_countMat,
  spatial_location = CARD_obj@spatial_location,
  gene.visualize = genes.list ,
  colors = NULL,
  NumCols = 6)

